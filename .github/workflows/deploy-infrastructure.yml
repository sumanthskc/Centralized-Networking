name: Deploy Hub + Spokes Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'cloudformation/**/*.yaml'
      - '.github/workflows/deploy-infrastructure.yml'

  workflow_dispatch:

env:
  AWS_REGION: "us-west-1"     # UPDATED REGION: NORTHERN CALIFORNIA
  HUB_ACCOUNT_ID: "881490088884"
  SPOKE_A_ACCOUNT_ID: "414329322210"
  SPOKE_B_ACCOUNT_ID: "417371242369"

jobs:
  deploy-hub:
    name: Deploy Hub Infrastructure (VPC + TGW)
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS OIDC Credentials (Hub)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: arn:aws:iam::881490088884:role/GitHubOIDCDeploymentRole
          role-session-name: GitHub-HubDeployment

      - name: Deploy Hub VPC + TGW
        run: |
          echo "Deploying hub VPC + TGW..."
          aws cloudformation deploy \
            --stack-name hub-networking \
            --template-file cloudformation/hub/centralized-vpc.yaml \
            --capabilities CAPABILITY_NAMED_IAM CAPABILITY_IAM \
            --parameter-overrides \
                EnvironmentName=Hub \
                VpcCIDR=10.0.0.0/16 \
                PublicSubnet1CIDR=10.0.1.0/24 \
                PublicSubnet2CIDR=10.0.2.0/24 \
                PrivateSubnet1CIDR=10.0.11.0/24 \
                PrivateSubnet2CIDR=10.0.12.0/24 \
                SpokeACIDR=10.1.0.0/16 \
                SpokeBCIDR=10.2.0.0/16 \
            --no-fail-on-empty-changeset \
            --region ${{ env.AWS_REGION }}

      - name: Get Transit Gateway ID
        id: tgw
        run: |
          TGW_ID=$(aws cloudformation describe-stacks \
            --stack-name hub-networking \
            --query "Stacks[0].Outputs[?OutputKey=='TransitGatewayId'].OutputValue" \
            --output text \
            --region ${{ env.AWS_REGION }} )
          echo "tgw_id=$TGW_ID" >> $GITHUB_OUTPUT
          echo "TGW ID = $TGW_ID"

    outputs:
      tgw_id: ${{ steps.tgw.outputs.tgw_id }}

  deploy-spokes:
    name: Deploy StackSet + Spoke A & B VPCs
    runs-on: ubuntu-latest
    needs: deploy-hub

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS OIDC Credentials (Hub)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.AWS_REGION }}
          role-to-assume: arn:aws:iam::881490088884:role/GitHubOIDCDeploymentRole
          role-session-name: GitHub-StackSetDeployment

      - name: Create or Update StackSet
        run: |
          TGW_ID=${{ needs.deploy-hub.outputs.tgw_id }}
          STACKSET_NAME="spoke-vpc-stackset"

          if aws cloudformation describe-stack-set --stack-set-name "$STACKSET_NAME" >/dev/null 2>&1; then
            echo "Updating StackSet..."
            aws cloudformation update-stack-set \
              --stack-set-name "$STACKSET_NAME" \
              --template-body file://cloudformation/spoke/spoke-vpc.yaml \
              --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
              --region ${{ env.AWS_REGION }}
          else
            echo "Creating StackSet..."
            aws cloudformation create-stack-set \
              --stack-set-name "$STACKSET_NAME" \
              --template-body file://cloudformation/spoke/spoke-vpc.yaml \
              --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
              --administration-role-arn arn:aws:iam::${{ env.HUB_ACCOUNT_ID }}:role/AWSCloudFormationStackSetAdministrationRole \
              --execution-role-name AWSCloudFormationStackSetExecutionRole \
              --region ${{ env.AWS_REGION }}
          fi

      - name: Deploy Spoke A Stack Instance
        run: |
          TGW_ID=${{ needs.deploy-hub.outputs.tgw_id }}

          aws cloudformation create-stack-instances \
            --stack-set-name spoke-vpc-stackset \
            --accounts ${{ env.SPOKE_A_ACCOUNT_ID }} \
            --regions ${{ env.AWS_REGION }} \
            --parameter-overrides \
              ParameterKey=EnvironmentName,ParameterValue=SpokeA \
              ParameterKey=VpcCIDR,ParameterValue=10.1.0.0/16 \
              ParameterKey=PublicSubnetCIDR,ParameterValue=10.1.1.0/24 \
              ParameterKey=PrivateSubnetCIDR,ParameterValue=10.1.11.0/24 \
              ParameterKey=TransitGatewayId,ParameterValue=$TGW_ID \
              ParameterKey=HubVpcCIDR,ParameterValue=10.0.0.0/16 \
              ParameterKey=OtherSpokeCIDR,ParameterValue=10.2.0.0/16 \
            --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=1 \
            --region ${{ env.AWS_REGION }}

      - name: Deploy Spoke B Stack Instance
        run: |
          TGW_ID=${{ needs.deploy-hub.outputs.tgw_id }}

          aws cloudformation create-stack-instances \
            --stack-set-name spoke-vpc-stackset \
            --accounts ${{ env.SPOKE_B_ACCOUNT_ID }} \
            --regions ${{ env.AWS_REGION }} \
            --parameter-overrides \
              ParameterKey=EnvironmentName,ParameterValue=SpokeB \
              ParameterKey=VpcCIDR,ParameterValue=10.2.0.0/16 \
              ParameterKey=PublicSubnetCIDR,ParameterValue=10.2.1.0/24 \
              ParameterKey=PrivateSubnetCIDR,ParameterValue=10.2.11.0/24 \
              ParameterKey=TransitGatewayId,ParameterValue=$TGW_ID \
              ParameterKey=HubVpcCIDR,ParameterValue=10.0.0.0/16 \
              ParameterKey=OtherSpokeCIDR,ParameterValue=10.1.0.0/16 \
            --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=1 \
            --region ${{ env.AWS_REGION }}

      - name: Deployment Complete
        run: |
          echo "Hub + Spoke A + Spoke B deployment completed in region: ${{ env.AWS_REGION }}"
