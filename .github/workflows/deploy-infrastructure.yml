name: Deploy Hub + Spokes Infrastructure

on:
  push:
    branches:
      - main
    paths:
      - 'cloudformation/**/*.yaml'
      - '.github/workflows/deploy-infrastructure.yml'

  workflow_dispatch:

env:
  AWS_REGION: "us-west-1"
  HUB_ACCOUNT_ID: "881490088884"
  SPOKE_A_ACCOUNT_ID: "414329322210"
  SPOKE_B_ACCOUNT_ID: "417371242369"
  EXECUTION_ROLE: "AWSCloudFormationStackSetExecutionRoleSumanth"

jobs:
  deploy-hub:
    name: Deploy Hub Infrastructure (VPC + TGW)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (Access Keys)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Deploy Hub VPC + TGW
        run: |
          echo "Deploying Hub VPC + Transit Gateway..."
          aws cloudformation deploy \
            --stack-name hub-networking \
            --template-file cloudformation/hub/centralized-vpc.yaml \
            --capabilities CAPABILITY_NAMED_IAM CAPABILITY_IAM \
            --parameter-overrides \
                EnvironmentName=Hub \
                VpcCIDR=10.0.0.0/16 \
                PublicSubnet1CIDR=10.0.1.0/24 \
                PublicSubnet2CIDR=10.0.2.0/24 \
                PrivateSubnet1CIDR=10.0.11.0/24 \
                PrivateSubnet2CIDR=10.0.12.0/24 \
                SpokeACIDR=10.1.0.0/16 \
                SpokeBCIDR=10.2.0.0/16 \
            --no-fail-on-empty-changeset \
            --region ${{ env.AWS_REGION }}

      - name: Extract Transit Gateway ID
        id: tgw
        run: |
          TGW_ID=$(aws cloudformation describe-stacks \
            --stack-name hub-networking \
            --query "Stacks[0].Outputs[?OutputKey=='TransitGatewayId'].OutputValue" \
            --output text \
            --region ${{ env.AWS_REGION }} )

          echo "tgw_id=$TGW_ID" >> $GITHUB_OUTPUT
          echo "Transit Gateway ID: $TGW_ID"

    outputs:
      tgw_id: ${{ steps.tgw.outputs.tgw_id }}

  deploy-spokes:
    name: Deploy StackSet + Spoke A & B VPCs
    runs-on: ubuntu-latest
    needs: deploy-hub

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS Credentials (Access Keys)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      ###############################################################
      # CREATE / UPDATE STACKSET
      ###############################################################
      - name: Create or Update StackSet
        run: |
          STACKSET="centralized-spoke-vpc-2"

          if aws cloudformation describe-stack-set --stack-set-name "$STACKSET" >/dev/null 2>&1; then
            echo "Updating StackSet..."
            aws cloudformation update-stack-set \
              --stack-set-name "$STACKSET" \
              --template-body file://cloudformation/spoke/spoke-vpc.yaml \
              --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
              --region ${{ env.AWS_REGION }}

          else
            echo "Creating StackSet with placeholder parameters..."
            aws cloudformation create-stack-set \
              --stack-set-name "$STACKSET" \
              --template-body file://cloudformation/spoke/spoke-vpc.yaml \
              --administration-role-arn arn:aws:iam::${{ env.HUB_ACCOUNT_ID }}:role/AWSCloudFormationStackSetAdministrationRole \
              --capabilities CAPABILITY_IAM CAPABILITY_NAMED_IAM \
              --parameters \
                ParameterKey=EnvironmentName,ParameterValue=Init \
                ParameterKey=VpcCIDR,ParameterValue=0.0.0.0/0 \
                ParameterKey=PublicSubnetCIDR,ParameterValue=0.0.0.0/0 \
                ParameterKey=PrivateSubnetCIDR,ParameterValue=0.0.0.0/0 \
                ParameterKey=TransitGatewayId,ParameterValue=dummy \
                ParameterKey=HubVpcCIDR,ParameterValue=0.0.0.0/0 \
                ParameterKey=OtherSpokeCIDR,ParameterValue=0.0.0.0/0 \
              --region ${{ env.AWS_REGION }}
          fi

      ###############################################################
      # FUNCTION: CREATE/UPDATE SPOKE INSTANCES
      ###############################################################

      - name: Deploy or Update Spoke A
        run: |
          TGW_ID=${{ needs.deploy-hub.outputs.tgw_id }}
          STACKSET="spoke-vpc-stackset"
          ACCOUNT=${{ env.SPOKE_A_ACCOUNT_ID }}
          REGION=${{ env.AWS_REGION }}
          ROLE=${{ env.EXECUTION_ROLE }}

          echo "Checking if Spoke A instance exists..."

          if aws cloudformation list-stack-instances \
                --stack-set-name $STACKSET \
                --region $REGION \
                --query "Summaries[?Account=='$ACCOUNT' && Region=='$REGION']" \
                | grep -q "$ACCOUNT"; then

            echo "Updating Spoke A..."
            aws cloudformation update-stack-instances \
              --stack-set-name $STACKSET \
              --accounts $ACCOUNT \
              --regions $REGION \
              --parameter-overrides \
                ParameterKey=EnvironmentName,ParameterValue=SpokeA \
                ParameterKey=VpcCIDR,ParameterValue=10.1.0.0/16 \
                ParameterKey=PublicSubnetCIDR,ParameterValue=10.1.1.0/24 \
                ParameterKey=PrivateSubnetCIDR,ParameterValue=10.1.11.0/24 \
                ParameterKey=TransitGatewayId,ParameterValue=$TGW_ID \
                ParameterKey=HubVpcCIDR,ParameterValue=10.0.0.0/16 \
                ParameterKey=OtherSpokeCIDR,ParameterValue=10.2.0.0/16 \
              --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=1 \
              --region $REGION

          else
            echo "Creating Spoke A..."
            aws cloudformation create-stack-instances \
              --stack-set-name $STACKSET \
              --accounts $ACCOUNT \
              --regions $REGION \
              --parameter-overrides \
                ParameterKey=EnvironmentName,ParameterValue=SpokeA \
                ParameterKey=VpcCIDR,ParameterValue=10.1.0.0/16 \
                ParameterKey=PublicSubnetCIDR,ParameterValue=10.1.1.0/24 \
                ParameterKey=PrivateSubnetCIDR,ParameterValue=10.1.11.0/24 \
                ParameterKey=TransitGatewayId,ParameterValue=$TGW_ID \
                ParameterKey=HubVpcCIDR,ParameterValue=10.0.0.0/16 \
                ParameterKey=OtherSpokeCIDR,ParameterValue=10.2.0.0/16 \
              --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=1 \
              --region $REGION
          fi

      - name: Deploy or Update Spoke B
        run: |
          TGW_ID=${{ needs.deploy-hub.outputs.tgw_id }}
          STACKSET="spoke-vpc-stackset"
          ACCOUNT=${{ env.SPOKE_B_ACCOUNT_ID }}
          REGION=${{ env.AWS_REGION }}
          ROLE=${{ env.EXECUTION_ROLE }}

          echo "Checking if Spoke B instance exists..."

          if aws cloudformation list-stack-instances \
                --stack-set-name $STACKSET \
                --region $REGION \
                --query "Summaries[?Account=='$ACCOUNT' && Region=='$REGION']" \
                | grep -q "$ACCOUNT"; then

            echo "Updating Spoke B..."
            aws cloudformation update-stack-instances \
              --stack-set-name $STACKSET \
              --accounts $ACCOUNT \
              --regions $REGION \
              --parameter-overrides \
                ParameterKey=EnvironmentName,ParameterValue=SpokeB \
                ParameterKey=VpcCIDR,ParameterValue=10.2.0.0/16 \
                ParameterKey=PublicSubnetCIDR,ParameterValue=10.2.1.0/24 \
                ParameterKey=PrivateSubnetCIDR,ParameterValue=10.2.11.0/24 \
                ParameterKey=TransitGatewayId,ParameterValue=$TGW_ID \
                ParameterKey=HubVpcCIDR,ParameterValue=10.0.0.0/16 \
                ParameterKey=OtherSpokeCIDR,ParameterValue=10.1.0.0/16 \
              --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=1 \
              --region $REGION

          else
            echo "Creating Spoke B..."
            aws cloudformation create-stack-instances \
              --stack-set-name $STACKSET \
              --accounts $ACCOUNT \
              --regions $REGION \
              --parameter-overrides \
                ParameterKey=EnvironmentName,ParameterValue=SpokeB \
                ParameterKey=VpcCIDR,ParameterValue=10.2.0.0/16 \
                ParameterKey=PublicSubnetCIDR,ParameterValue=10.2.1.0/24 \
                ParameterKey=PrivateSubnetCIDR,ParameterValue=10.2.11.0/24 \
                ParameterKey=TransitGatewayId,ParameterValue=$TGW_ID \
                ParameterKey=HubVpcCIDR,ParameterValue=10.0.0.0/16 \
                ParameterKey=OtherSpokeCIDR,ParameterValue=10.1.0.0/16 \
              --operation-preferences FailureToleranceCount=0,MaxConcurrentCount=1 \
              --region $REGION
          fi

      - name: Deployment Complete
        run: |
          echo "Hub VPC + TGW + Spoke A + Spoke B deployment completed successfully in region: ${{ env.AWS_REGION }}"
